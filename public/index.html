<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="manifest" href="manifest.json" />
    <title>Seul.</title>

    <link rel="stylesheet" type="text/css" href="style.css" />
    <!-- bootstrap - css-->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />

    <!-- html2canvas - js -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  </head>
  
  <body>
    <!-- bootstrap - js -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
      crossorigin="anonymous"
    ></script>

    <!-- jquery -->
    <script
      src="https://code.jquery.com/jquery-3.7.0.min.js"
      integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
      crossorigin="anonymous"
    ></script>

    <!-- ìƒë‹¨ Bar -->
    <div class="link-bar">
      <a href="index.html"><img src="./image/seulmainlogo.png" alt="Seul." width="100" height="50"></a>
      <a href="tutorial.html">Tutorial</a>
      <a id="create-link" href="upload.html">Create</a>
      <button id="gogleLogout" class="logout-btn">Logout</button>
    </div>

   <!-- ì»¤í”¼ ì´ë²¤íŠ¸ <fixed button> -->
    <div id="mybutton">
      <button class="coffee-event" onclick="window.location.href='https://forms.gle/pv3erLw5ZnwLR7b38';">
        Coffee Eventâ˜•ï¸
      </button>
    </div>
    
   <!-- ë²„ê·¸ ë¦¬í¬íŠ¸ <fixed button> -->
    <div id="bugbutton">
      <button class="bug-report" onclick="window.location.href='https://forms.gle/czV4yh4MTEa6D4mu5';">
        Bug ReportğŸš¨
      </button>
    </div>


    <!-- í”¼ë“œ ë ˆì´ì•„ì›ƒ -->
    <div class="container mt-3"></div>

    <!-- firebase sdk -->
    <script type="module">
      // SDKì—ì„œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ import
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
      import {
        getStorage,
        ref,
        uploadBytesResumable,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";
      import {
        getFirestore,
        addDoc,
        collection,
        getDocs,
        orderBy,
        query,
        doc,
        updateDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
      import {
        getAuth,
        signOut,
        signInWithPopup,
        GoogleAuthProvider,
        FacebookAuthProvider,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

      // Import the necessary Firebase functions
      import { arrayRemove } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
      // deleteObject í•¨ìˆ˜ import
      import { deleteObject } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-storage.js";

      // Import the functions you need from the SDKs you need
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-analytics.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyC_2nHVC8RY4xDfMwVlQtp8bbDY8ks-U74",
        authDomain: "seul-3projm-808e4.firebaseapp.com",
        projectId: "seul-3projm-808e4",
        storageBucket: "seul-3projm-808e4.appspot.com",
        messagingSenderId: "23219568493",
        appId: "1:23219568493:web:ee3360d6ed3149a946e464",
        measurementId: "G-5FYNH0ZF4M",
      };

      // Firebase ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);

      // Firebase Analytics ì´ˆê¸°í™”
      const analytics = getAnalytics(app);

      // Firestore ì•¡ì„¸ìŠ¤
      const db = getFirestore();

      // Storage ì•¡ì„¸ìŠ¤
      const storage = getStorage();

      // Authentication ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
      const auth = getAuth();

      // ì¢‹ì•„ìš” ê¸°ëŠ¥ì„ ìœ„í•œ ì‚¬ìš©ì ì´ˆê¸°í™”
      let user = null;
      
      // Google Logout
      document.getElementById("gogleLogout").addEventListener("click", () => {
        if (user) {  
          signOut(auth).then(() => {
            alert("User logged out successfully!)");
            // ë¡œê·¸ì¸ ì„±ê³µ í›„ index.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            window.location.href = "index.html";
          }).catch((error) => {
            // An error happened.
            console.error("Error logging out:", error);
          });
        }else{
          alert("Already logged out");
        }
      });

      onAuthStateChanged(auth, (currentUser) => {
        if (currentUser) {
          // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ì €ì¥
          user = currentUser;

          // Show "Sign out with Google" button and hide "Login" button
          document.getElementById("gogleLogout").style.display = "block";
          // ë¡œê·¸ì¸í•œ ê²½ìš°, 'Create' ë§í¬ë¥¼ 'upload.html'ë¡œ ë³€ê²½
          document.getElementById("create-link").href = "upload.html";
        } 
        
        else {
          // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
          user = null;
         
          // Show "Login" button and hide "Sign out with Google" button
          document.getElementById("gogleLogout").style.display = "none";
          // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°, 'Create' ë§í¬ë¥¼ 'login.html'ë¡œ ë³€ê²½
          document.getElementById("create-link").href = "login.html";
        }
      });

      const productCollection = collection(db, "feed");
      const productQuery = query(
        productCollection,
        orderBy("createdAt", "desc")
      );

      getDocs(productQuery).then((ê²°ê³¼) => {
        ê²°ê³¼.docs.forEach((doc) => {
          const imageData = doc.data(); // Get doc data
          const docId = doc.id; // Get document id
          let joinImageUrl = [];

          // ì¢‹ì•„ìš” ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          let likes = Array.isArray(imageData.ì¢‹ì•„ìš”) ? imageData.ì¢‹ì•„ìš” : [];

          // ì¢‹ì•„ìš” ê¸°ëŠ¥ ê´€ë ¨ ë³€ìˆ˜ ì´ˆê¸°í™” for ê·¸ëƒ¥ view ìœ ì €ë“¤
          let isLiked = false;
          let likeIconImage = "./image/heart1.png"; // Default like icon image

          // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ìƒíƒœì¸ì§€ í™•ì¸
          if (user) {
            isLiked = likes.includes(user.uid); // ì‚¬ìš©ìê°€ ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ëŠ”ì§€ í™•ì¸
            // ì¢‹ì•„ìš” ì•„ì´ì½˜ ì´ë¯¸ì§€ ì„¤ì •
            likeIconImage = isLiked
              ? "./image/heart3.png"
              : "./image/heart1.png";
          }

          if (
            imageData.hasOwnProperty("joinimage") &&
            Array.isArray(imageData.joinimage)
          ) {
            // Check if 'joinimage' field exists and it's an array
            joinImageUrl = imageData.joinimage; // ì´ë¯¸ì§€ URLë“¤ì˜ ë°°ì—´
          }

          // Get post ID from URL query params in upload.html
          const urlParams = new URLSearchParams(window.location.search);
          const postId = urlParams.get("postId");

          let imageTemplates = [];

          // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ëŠ” í•­ìƒ imageData.ì´ë¯¸ì§€ì— ìˆìŠµë‹ˆë‹¤.
          imageTemplates[0] = `<img class="frame-img" src="${imageData.ì´ë¯¸ì§€}" alt="Image">`;

          for (let i = 0; i < 3; i++) {
            if (joinImageUrl[i]) {
              imageTemplates[i + 1] = `<img class="frame-img" src="${
                joinImageUrl[i]
              }" data-index="${i + 1}" alt="Join Image">`;
            } else {
              imageTemplates[
                i + 1
              ] = `<a class="frame-link" data-postId="${docId}"><img class="frame-img" src="./image/joinhere.png"></a>`;
            }
          }

          // í”¼ë“œ í…œí”Œë¦¿ ìƒì„±
          var í…œí”Œë¦¿ = `
          <div class="box">
            <div class="profile">
              <img class="profile-img" src="./image/seul_logo.png" alt="Profile">
              <link rel="stylesheet" type="text/css" href="style.css">
              <h5 class="title">${imageData.ì œëª©}</h5>
              <div class="dropdown">
              <img class="more-img" src="./image/more_vert.png" alt="More" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                <li><a class="dropdown-item save-option" href="contact.html
                  ">Contact Us</a></li>
              </ul>
            </div>
            </div>
            <div class="frame" data-id="${docId}">
              ${imageTemplates.join("")}
              <h4 class="seul">Seul.</h4>
            </div>
            <p class="content">#${imageData.ë‚´ìš©}</p>
            <div class="likes" data-id="${docId}" data-liked="${isLiked}">
              <img src="${likeIconImage}" class="like-icon" alt="Like Icon">
              <h3 class="like-count">${likes.length}</h3>
            </div>
          </div>
          <br>
          <div class="divide-line"></div>
          <br>
          `;
          $(".container").append(í…œí”Œë¦¿);
        });

        // Join í•¨ìˆ˜
        // ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ëª»í•¨
        // ë‚´ê°€ ìƒì„±í•œ í”¼ë“œë©´ Join ëª»í•¨
        // ë‚´ê°€ ì´ë¯¸ Joiní•œ í”¼ë“œë©´ Join ëª»í•¨
        $(document).on("click", ".frame-link", async function () {
          // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸
          if (user) {
            let $makerContainer = $(this).parent();
            let postId = $makerContainer.data("id");

            const postRef = doc(db, "feed", postId);
            const postDoc = await getDoc(postRef);
            const feedData = postDoc.data();
            const makers = Array.isArray(feedData.makers)
              ? feedData.makers
              : [];

            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ í”¼ë“œì˜ ìƒì„±ìë‚˜ ì´ë¯¸ ì°¸ì—¬í•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
            if (!makers.includes(user.uid)) {
              // ì´ë¯¸ì§€ê°€ ì±„ì›Œì ¸ ìˆì§€ ì•Šìœ¼ë©´ join.htmlë¡œ ì´ë™
              window.location.href = `join.html?postId=${postId}`;
            } else {
              // ìì‹ ì´ ìƒì„±í•œ í”¼ë“œì—ëŠ” ì°¸ì—¬í•  ìˆ˜ ì—†ë‹¤ëŠ” ë©”ì‹œì§€ë¥¼ íŒì—…ìœ¼ë¡œ ë„ì›€
              alert("You already join this feed! :)");
            }
          } else {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ login.htmlë¡œ ì´ë™
            window.location.href = "login.html";
          }
        });

        // ì¢‹ì•„ìš” ê¸°ëŠ¥
        $(document).on("click", ".like-icon", async function () {
          if (!user) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ login.htmlë¡œ ì´ë™
            window.location.href = "login.html";
          }

          let $likeContainer = $(this).parent();
          let postId = $likeContainer.data("id");
          let $likeCount = $likeContainer.find(".like-count");

          const postRef = doc(db, "feed", postId);
          const postDoc = await getDoc(postRef);
          const postData = postDoc.data();
          const likes = postData.ì¢‹ì•„ìš” || [];

          if (likes.includes(user.uid)) {
            // ì´ë¯¸ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìœ¼ë©´ ì¢‹ì•„ìš” ì·¨ì†Œ
            const newLikes = likes.filter((uid) => uid !== user.uid);
            await updateDoc(postRef, { ì¢‹ì•„ìš”: newLikes });

            $(this).attr("src", "./image/heart1.png");
            $likeCount.text(newLikes.length); // ì¢‹ì•„ìš” ìˆ˜ë¥¼ ë°°ì—´ì˜ ê¸¸ì´ë¡œ í‘œì‹œ
          } else {
            // ì¢‹ì•„ìš” ì¶”ê°€
            const newLikes = [...likes, user.uid];
            await updateDoc(postRef, { ì¢‹ì•„ìš”: newLikes });

            $(this).attr("src", "./image/heart3.png");
            $likeCount.text(newLikes.length); // ì¢‹ì•„ìš” ìˆ˜ë¥¼ ë°°ì—´ì˜ ê¸¸ì´ë¡œ í‘œì‹œ
          }
        });

        // // Joiní•œ Frame ì‚­ì œ

        // ì´ë¯¸ì§€ URLì—ì„œ íŒŒì¼ ê²½ë¡œë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function extractFilePathFromURL(imageUrl) {
          // ì´ë¯¸ì§€ URLì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œí•˜ê¸°
          // ì˜ˆë¥¼ ë“¤ì–´, imageUrlì´ "https://firebasestorage.googleapis.com/v0/b/seulfortest.appspot.com/o/image%2F20221227_170902.jpg?alt=media&token=245f0f58-59eb-4472-9644-dc7897df9f41" í˜•ì‹ì´ë¼ë©´,
          // íŒŒì¼ ê²½ë¡œì¸ "image%2F20221227_170902.jpg" ë¶€ë¶„ë§Œ ì¶”ì¶œí•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
          const startIndex = imageUrl.lastIndexOf("/") + 1;
          const endIndex = imageUrl.indexOf("?");
          return imageUrl.substring(startIndex, endIndex);
        }

        // Joiní•œ ì´ë¯¸ì§€ë¥¼ Firestoreì™€ Storageì—ì„œ ì‚­ì œí•˜ëŠ” í•¨ìˆ˜
        async function removeJoinImage(postId, joinImageIndex) {
          const postRef = doc(db, "feed", postId);

          try {
            const postSnap = await getDoc(postRef);
            const imageData = postSnap.data();

            if (
              imageData.hasOwnProperty("ì´ë¯¸ì§€") &&
              Array.isArray(imageData.ì´ë¯¸ì§€) &&
              imageData.hasOwnProperty("joinimage") &&
              Array.isArray(imageData.joinimage)
            ) {
              const joinImageArray = imageData.joinimage;

              // console.log("joinImageIndex:", joinImageIndex);
              // console.log("imageData:", imageData);
              // console.log("joinImageArray:", joinImageArray);

              // ì¸ë±ìŠ¤ê°€ ì˜¬ë°”ë¥¸ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
              if (
                joinImageIndex >= 0 &&
                joinImageIndex <= joinImageArray.length
              ) {
                const joinImageToDelete = joinImageArray[joinImageIndex];
                const filePath = joinImageToDelete.replace(
                  "gs://seulfortest.appspot.com/",
                  ""
                );

                // console.log("joinImageToDelete:", joinImageToDelete);
                // console.log("filePath:", filePath);

                // Storageì—ì„œ joinimage ì‚­ì œ
                const imageRef = ref(storage, filePath);
                await deleteObject(imageRef);

                // joinimage ë°°ì—´ì—ì„œ ì´ë¯¸ì§€ URL ì‚­ì œ
                joinImageArray.splice(joinImageIndex, 1);

                // makers ë°°ì—´ì—ì„œ í•´ë‹¹ ì¸ë±ìŠ¤ ê°’ ì‚­ì œ
                const makersArray = imageData.makers;
                makersArray.splice(joinImageIndex + 1, 1);

                // ë°°ì—´ì„ ë‹¤ì‹œ Firestore ì—…ë°ì´íŠ¸
                await updateDoc(postRef, {
                  joinimage: joinImageArray,
                  makers: makersArray,
                });
              }
            }
          } catch (error) {
            console.error("Error removing joinimage:", error);
          }
        }

        $(document).on("click", ".frame-img", async function () {
          let $frame = $(this).closest(".frame");
          let postId = $frame.data("id");
          let imageIndex = $(this).data("index");

          // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
          if (!user) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ë‹¤ë©´ login.htmlë¡œ ì´ë™
            window.location.href = "login.html";
            return;
          }

          const postRef = doc(db, "feed", postId);

          try {
            const postSnap = await getDoc(postRef);
            const imageData = postSnap.data();

             // ì´ë¯¸ì§€ê°€ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸
             if ($(this).attr("src") && $(this).attr("src").trim() !== "" && $(this).attr("src").trim() !== "./image/joinhere.png") {
              // ì´ë¯¸ì§€ ì—…ë¡œë“œìì™€ í˜„ì¬ ì‚¬ìš©ì ë¹„êµ
              const makers = Array.isArray(imageData.makers)
                ? imageData.makers
                : [];
              const currentMaker = makers[imageIndex];

              // ì‚¬ì§„ì´ ì±„ì›Œì ¸ ìˆëŠ”ë°, ìœ ì €ê°€ ë‹¤ë¥¸ ê²½ìš°
              if (user.uid !== currentMaker) {
                alert("You cannot delete this image.");
                return;
              }
            }
          } catch (error) {
            console.error("Error reading document:", error);
          }

          // ì´ë¯¸ì§€ê°€ í´ë¦­ë˜ì§€ ì•Šì€ ê²½ìš° ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
          if (typeof imageIndex === "undefined") {
            return;
          }

          // ì´ë¯¸ì§€ê°€ ì±„ì›Œì ¸ ìˆëŠ”ì§€ í™•ì¸
          if ($(this).attr("src") && $(this).attr("src").trim() !== "") {
            // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ì¸ ê²½ìš° ì‚­ì œ ë¶ˆê°€
            if (imageIndex === 0) {
              // ì´ë¯¸ì§€ê°€ ì²« ë²ˆì§¸ì¸ ê²½ìš° ì•„ë¬´ ë™ì‘ë„ í•˜ì§€ ì•ŠìŒ
              return;
            }

            // ì´ë¯¸ì§€ ì‚­ì œ í™•ì¸
            if (
              confirm(
                "Are you sure delete your image? \nThe order of the current images might be affected!"
              )
            ) {
              // ì´ë¯¸ì§€ ì‚­ì œ
              await removeJoinImage(postId, imageIndex - 1);

              // í”„ë ˆì„ì—ì„œ ì´ë¯¸ì§€ ì‚­ì œ í›„ ë¹ˆ í”„ë ˆì„ ì´ë¯¸ì§€ë¡œ êµì²´
              $(this).replaceWith(
                `<a href="join.html?postId=${postId}"><img class="frame-img" src="./image/joinhere.png"></a>`
              );
            }
          } else {
            // ì´ë¯¸ì§€ê°€ ì±„ì›Œì ¸ ìˆì§€ ì•Šìœ¼ë©´ join.htmlë¡œ ì´ë™
            window.location.href = `join.html?postId=${postId}`;
          }
        });

        //   // Save frame as an image
        //   $(document).on("click", ".save-option", function (e) {
        //     e.preventDefault();

        //     const frameElement = $(this).closest(".box").find(".frame")[0];

        //     html2canvas(frameElement, { useCORS: true }).then(function (canvas) {
        //       let el = document.createElement("a");
        //       el.href = canvas.toDataURL("image/jpeg");
        //       el.download = "frame.jpg"; // íŒŒì¼ëª… ì„¤ì •
        //       document.body.appendChild(el);
        //       el.click();
        //       document.body.removeChild(el);
        //     });
        //   });
      });
    </script>
  </body>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('pwabuilder-sw.js');
    }
  </script>
</html>
